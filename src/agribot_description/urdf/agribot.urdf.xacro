<?xml version="1.0"?>
<robot name="agribot" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <material name="blue"><color rgba="0 0 0.8 1"/></material>
  <material name="black"><color rgba="0 0 0 1"/></material>
  <link name="base_footprint"/>

<joint name="base_footprint_joint" type="fixed">
  <parent link="base_footprint"/>
  <child link="base_link"/>
  <origin xyz="0 0 0.1" rpy="0 0 0"/> </joint>

  <link name="base_link">
    <visual>
      <geometry><box size="0.6 0.4 0.2"/></geometry>
      <material name="blue"/>
    </visual>
    <collision>
      <geometry><box size="0.6 0.4 0.2"/></geometry>
    </collision>
    <inertial>
      <mass value="5.0"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
    </inertial>
  </link>

  <xacro:macro name="wheel" params="prefix x y">
    <link name="${prefix}_wheel">
      <visual>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
        <material name="black"/>
      </visual>
      <collision>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
      <inertial>
        <mass value="0.5"/>
        <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
      </inertial>
    </link>
    <joint name="${prefix}_wheel_joint" type="continuous">
      <parent link="base_link"/>
      <child link="${prefix}_wheel"/>
      <origin xyz="${x} ${y} -0.1" rpy="-1.5708 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>
  </xacro:macro>

  <xacro:wheel prefix="front_left" x="0.2" y="0.25"/>
  <xacro:wheel prefix="front_right" x="0.2" y="-0.25"/>
  <xacro:wheel prefix="back_left" x="-0.2" y="0.25"/>
  <xacro:wheel prefix="back_right" x="-0.2" y="-0.25"/>

  <link name="lidar_link">
    <visual><geometry><cylinder radius="0.05" length="0.1"/></geometry><material name="black"/></visual>
  </link>
  <joint name="lidar_joint" type="fixed">
    <parent link="base_link"/><child link="lidar_link"/><origin xyz="0 0 0.15"/>
  </joint>

  <!-- Replace the old gpu_lidar block with this gpu_ray/ray sensor -->
  <gazebo reference="lidar_link">
    <sensor name="lidar" type="gpu_ray">
      <update_rate>20</update_rate>
      <topic>scan</topic>
      <!-- optional: set the frame id that will be used on the published message -->
      <gz_frame_id>lidar_link</gz_frame_id>

      <ray>
        <scan>
          <horizontal>
            <!-- samples should match desired angular resolution (e.g. 360 or 640) -->
            <samples>640</samples>
            <resolution>1</resolution>
            <min_angle>-3.14159</min_angle>
            <max_angle>3.14159</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.1</min>
          <max>10.0</max>
        </range>
      </ray>
    </sensor>
  </gazebo>


  <link name="camera_link">
    <visual><geometry><box size="0.05 0.05 0.05"/></geometry><material name="black"/></visual>
  </link>
  <joint name="camera_joint" type="fixed">
    <parent link="base_link"/><child link="camera_link"/><origin xyz="0.31 0 0.1"/>
  </joint>

  <gazebo reference="camera_link">
    <sensor name="camera" type="camera">
      <pose>0 0 0 0 0 0</pose>
      <visualize>true</visualize>
      <update_rate>20</update_rate>
      <topic>camera</topic>
      <gz_frame_id>camera_link</gz_frame_id>
      <camera>
        <horizontal_fov>1.089</horizontal_fov>
        <image>
          <width>640</width>
          <height>480</height>
          <format>R8G8B8</format>
        </image>
        <clip><near>0.05</near><far>100</far></clip>
      </camera>
    </sensor>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
      <left_joint>front_left_wheel_joint</left_joint>
      <left_joint>back_left_wheel_joint</left_joint>
      <right_joint>front_right_wheel_joint</right_joint>
      <right_joint>back_right_wheel_joint</right_joint>
      <wheel_separation>0.5</wheel_separation>
      <wheel_radius>0.1</wheel_radius>
      <topic>/model/agribot/cmd_vel</topic> 
      <odom_topic>/model/agribot/odometry</odom_topic>
      <tf_topic>/model/agribot/tf</tf_topic>
      <frame_id>odom</frame_id>
      <child_frame_id>base_footprint</child_frame_id>
      <publish_odom>true</publish_odom>
      <publish_odom_tf>true</publish_odom_tf>
      <publish_wheel_tf>true</publish_wheel_tf>
    </plugin>
    <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher">
    <topic>joint_states</topic>
    <joint_name>front_left_wheel_joint</joint_name>
    <joint_name>front_right_wheel_joint</joint_name>
    <joint_name>back_left_wheel_joint</joint_name>
    <joint_name>back_right_wheel_joint</joint_name>
  </plugin>
    <plugin filename="gz-sim-sensors-system" name="gz::sim::systems::Sensors">
      <render_engine>ogre2</render_engine>
    </plugin>
  </gazebo>
</robot>
